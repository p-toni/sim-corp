version: "3.9"

services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: sim-mosquitto
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    ports:
      - "1883:1883"
      - "9001:9001"

  company-kernel:
    image: node:20-bullseye
    container_name: sim-company-kernel
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/company-kernel start"
    environment:
      NODE_ENV: development
      KERNEL_DB_PATH: /data/kernel.db
      DEV_ORG_ID: org
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
      - ../../var/kernel:/data
    ports:
      - "3000:3000"
    depends_on:
      - mosquitto

  ingestion:
    image: node:20-bullseye
    container_name: sim-ingestion
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/ingestion start"
    environment:
      NODE_ENV: development
      INGESTION_MQTT_URL: mqtt://mosquitto:1883
      INGESTION_MQTT_CLIENT_ID: ingestion-local
      INGESTION_DB_PATH: /data/ingestion.db
      AUTO_REPORT_MISSIONS_ENABLED: "true"
      INGESTION_KERNEL_URL: http://company-kernel:3000
      INGESTION_OPS_EVENTS_ENABLED: "true"
      INGESTION_OPS_MQTT_URL: mqtt://mosquitto:1883
      INGESTION_KERNEL_ENQUEUE_FALLBACK_ENABLED: "true"
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
      - ../../var/ingestion:/data
    ports:
      - "4001:4001"
    depends_on:
      - mosquitto

  sim-twin:
    image: node:20-alpine
    container_name: sim-twin
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/sim-twin start"
    environment:
      NODE_ENV: development
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4002:4002"

  sim-publisher:
    image: node:20-alpine
    container_name: sim-publisher
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/sim-publisher start"
    environment:
      NODE_ENV: development
      MQTT_URL: mqtt://mosquitto:1883
      SIM_TWIN_URL: http://sim-twin:4002
      SIGNING_MODE: ed25519
      SIGNING_AUTO_REGISTER: "true"
      KERNEL_URL: http://company-kernel:3000
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4003:4003"
    depends_on:
      - mosquitto
      - sim-twin

  driver-bridge:
    image: node:20-alpine
    container_name: sim-driver-bridge
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/driver-bridge start"
    environment:
      NODE_ENV: development
      MQTT_URL: mqtt://mosquitto:1883
      SIGNING_MODE: ed25519
      SIGNING_AUTO_REGISTER: "true"
      KERNEL_URL: http://company-kernel:3000
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4004:4004"
    depends_on:
      - mosquitto

  event-inference:
    image: node:20-alpine
    container_name: sim-event-inference
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/event-inference start"
    environment:
      NODE_ENV: development
      MQTT_URL: mqtt://mosquitto:1883
      EVENT_INFERENCE_PORT: 4005
      SIGNING_MODE: ed25519
      SIGNING_AUTO_REGISTER: "true"
      SIGNING_ORG_ID: org
      KERNEL_URL: http://company-kernel:3000
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4005:4005"
    depends_on:
      - mosquitto

  analytics:
    image: node:20-alpine
    container_name: sim-analytics
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/analytics start"
    environment:
      NODE_ENV: development
      INGESTION_URL: http://ingestion:4001
      ANALYTICS_PORT: 4006
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4006:4006"
    depends_on:
      - ingestion

  report-worker:
    image: node:20-alpine
    container_name: sim-report-worker
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/report-worker start"
    environment:
      NODE_ENV: development
      KERNEL_URL: http://company-kernel:3000
      INGESTION_URL: http://ingestion:4001
      ANALYTICS_URL: http://analytics:4006
      REPORT_WORKER_PORT: 4007
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4007:4007"
    depends_on:
      - company-kernel
      - ingestion
      - analytics

  dispatcher:
    image: node:20-bullseye
    container_name: sim-dispatcher
    working_dir: /app
    command: sh -c "corepack enable && pnpm --filter @sim-corp/dispatcher start"
    environment:
      NODE_ENV: development
      KERNEL_URL: http://company-kernel:3000
      DISPATCHER_MQTT_URL: mqtt://mosquitto:1883
      DISPATCHER_PORT: 4010
    volumes:
      - ../../:/app
      - ../../node_modules:/app/node_modules
    ports:
      - "4010:4010"
    depends_on:
      - mosquitto
      - company-kernel

networks:
  default:
    name: sim-local
