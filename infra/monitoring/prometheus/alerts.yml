# Prometheus Alert Rules for Sim-Corp Production Stack

groups:
  - name: service_health
    interval: 30s
    rules:
      # Service Down Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          sum(rate(simcorp_http_requests_total{status_code=~"5.."}[5m])) by (service)
          /
          sum(rate(simcorp_http_requests_total[5m])) by (service)
          > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "{{ $labels.service }} has >5% error rate ({{ $value | humanizePercentage }})"

      # High Latency (p95 > 1s)
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            rate(simcorp_http_request_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on {{ $labels.service }}"
          description: "{{ $labels.service }} p95 latency is {{ $value }}s (>1s threshold)"

  - name: resource_alerts
    interval: 30s
    rules:
      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          (simcorp_process_resident_memory_bytes / 1024 / 1024 / 1024) > 1.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.service }}"
          description: "{{ $labels.service }} is using {{ $value | humanize }}GB of memory (>1.5GB)"

      # High CPU Usage
      - alert: HighCPUUsage
        expr: |
          rate(simcorp_process_cpu_user_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.service }}"
          description: "{{ $labels.service }} CPU usage is {{ $value | humanizePercentage }}"

  - name: business_metrics
    interval: 30s
    rules:
      # Mission Queue Backlog
      - alert: MissionQueueBacklog
        expr: simcorp_missions_active > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Large mission queue backlog"
          description: "{{ $value }} missions are currently active (>100 threshold)"

      # Session Close Rate Drop
      - alert: LowSessionCloseRate
        expr: |
          rate(simcorp_sessions_closed_total[10m]) < 0.01
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Low session close rate"
          description: "Session close rate has dropped below expected levels"

      # Command Approval Rate Low
      - alert: LowCommandApprovalRate
        expr: |
          sum(rate(simcorp_missions_completed_total{status="approved"}[10m]))
          /
          sum(rate(simcorp_missions_queued_total[10m]))
          < 0.5
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Low command approval rate"
          description: "Command approval rate is {{ $value | humanizePercentage }} (<50%)"

  - name: data_quality
    interval: 30s
    rules:
      # Low Telemetry Verification Rate
      - alert: LowVerificationRate
        expr: simcorp_telemetry_verification_rate < 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low telemetry verification rate"
          description: "Only {{ $value }}% of telemetry points are verified (<80% threshold)"

  - name: backup_health
    interval: 1m
    rules:
      # Backup Service Down
      - alert: BackupServiceDown
        expr: up{job="backup"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Backup service is down"
          description: "The backup service has been down for more than 5 minutes. Automated backups are not running."

      # No Recent Backup (Critical)
      - alert: NoRecentBackup
        expr: |
          (time() - simcorp_backup_last_success_timestamp_seconds) > 7200
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No successful backup in 2 hours"
          description: "The last successful backup was {{ $value | humanizeDuration }} ago. RTO/RPO targets at risk."

      # Old Backup (Warning)
      - alert: BackupTooOld
        expr: |
          (time() - simcorp_backup_last_success_timestamp_seconds) > 3900
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "No backup in over 1 hour"
          description: "The last backup was {{ $value | humanizeDuration }} ago (expected hourly)."

      # Backup Size Anomaly
      - alert: BackupSizeAnomaly
        expr: |
          abs(simcorp_backup_size_bytes - avg_over_time(simcorp_backup_size_bytes[7d]))
          >
          0.5 * avg_over_time(simcorp_backup_size_bytes[7d])
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Backup size changed significantly"
          description: "Backup size is {{ $value | humanize }}B, which deviates >50% from 7-day average. Possible data loss or corruption."

      # Backup Failures
      - alert: BackupFailures
        expr: |
          increase(simcorp_backup_failures_total[1h]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Backup failures detected"
          description: "{{ $value }} backup failures in the last hour."

      # Slow Backup
      - alert: SlowBackup
        expr: simcorp_backup_duration_seconds > 600
        for: 1m
        labels:
          severity: info
        annotations:
          summary: "Backup taking longer than expected"
          description: "Last backup took {{ $value }}s (>10 minutes). Database size may be growing."

      # Low Backup Disk Space
      - alert: LowBackupDiskSpace
        expr: |
          (1 - (simcorp_backup_disk_free_bytes / simcorp_backup_disk_total_bytes)) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space for backups"
          description: "Backup volume is {{ $value | humanizePercentage }} full. Clean up old backups or increase storage."

      # Failed Backup Verification
      - alert: BackupVerificationFailed
        expr: simcorp_backup_verification_last_status != 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Backup verification failed"
          description: "The last backup verification test failed. Backups may not be restorable."
