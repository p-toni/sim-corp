# Autonomy Governance - Operator Runbook

This runbook provides operational procedures for managing the Autonomy Governance system.

## Table of Contents

- [Daily Operations](#daily-operations)
- [Weekly Procedures](#weekly-procedures)
- [Phase Transitions](#phase-transitions)
- [Incident Response](#incident-response)
- [Circuit Breaker Management](#circuit-breaker-management)
- [Maintenance](#maintenance)
- [Troubleshooting](#troubleshooting)

## Daily Operations

### Morning Checks

**Duration**: 5-10 minutes

1. **Check Service Health**
   ```bash
   curl http://localhost:4007/health
   ```
   Expected: `{"status":"healthy","service":"governance",...}`

2. **Review Overnight Metrics**
   - Open Grafana dashboard: http://localhost:3000/d/autonomy-governance
   - Check command success rate: Should be > 99.5%
   - Check error rate: Should be < 0.5%
   - Review any circuit breaker events

3. **Check for Unresolved Circuit Breaker Events**
   ```bash
   curl http://localhost:4007/api/circuit-breaker/events/unresolved
   ```
   - If empty `[]`: ‚úÖ All clear
   - If events present: Follow [Circuit Breaker Response](#circuit-breaker-response)

4. **Review Readiness Score**
   ```bash
   curl http://localhost:4007/api/readiness/score | jq
   ```
   - Score < 0.90: ‚ö†Ô∏è Investigation needed
   - Score 0.90-0.95: üëç Good, monitor trends
   - Score ‚â• 0.95: ‚úÖ Ready for expansion

### Throughout the Day

- Monitor Grafana dashboard for anomalies
- Watch for Prometheus alerts
- Respond to circuit breaker events within SLA:
  * Critical: 5 minutes
  * High: 15 minutes
  * Medium: 1 hour
  * Low: Next business day

## Weekly Procedures

### Friday End-of-Week Review

**Duration**: 20-30 minutes
**When**: Friday 4:00 PM (before week end)

1. **Run Weekly Governance Cycle**
   ```bash
   curl -X POST http://localhost:4007/api/governance/run-cycle | jq > report.json
   ```

2. **Review Governance Report**
   ```bash
   # View latest report
   curl http://localhost:4007/api/governance/reports/latest | jq
   ```

   Key sections to review:
   - **Metrics**: Command execution trends
   - **Readiness**: Overall score and category breakdown
   - **Recommendation**: Expand, maintain, or investigate
   - **Circuit Breaker Events**: Any safety triggers
   - **Proposal**: If generated, review expansion proposal

3. **Review Pending Proposals**
   ```bash
   curl http://localhost:4007/api/governance/proposals | jq
   ```

   For each proposal:
   - Review key achievements
   - Assess risk level
   - Verify required approvals obtained
   - Check validation period

4. **Update Stakeholders**
   - Email weekly report summary to stakeholders
   - Highlight any readiness score changes
   - Note any circuit breaker events
   - Flag pending proposals requiring approval

### Monthly Review

**Duration**: 1-2 hours
**When**: First Friday of month

1. **Analyze Trends**
   - Review 30-day metrics history
   - Compare month-over-month readiness scores
   - Identify patterns in circuit breaker events
   - Review command execution volume trends

2. **Review Circuit Breaker Rules**
   ```bash
   curl http://localhost:4007/api/circuit-breaker/rules | jq
   ```
   - Check if thresholds need adjustment
   - Review false positive rate
   - Consider adding new rules based on incidents

3. **Update Readiness Checklist**
   - Review checklist items for relevance
   - Update based on operational learnings
   - Adjust weights if priorities changed

4. **Database Maintenance**
   ```bash
   # Check database size
   ls -lh services/governance/var/governance.db

   # Archive old data if > 1GB
   # Keep last 90 days, archive older records
   ```

## Phase Transitions

### Approving Scope Expansion Proposal

**Prerequisites**:
- Proposal generated by governance agent
- All required approvals obtained
- Stakeholders reviewed and approved

**Procedure**:

1. **Review Proposal Details**
   ```bash
   curl http://localhost:4007/api/governance/proposals | jq '.[0]'
   ```

   Verify:
   - ‚úÖ Target phase is correct
   - ‚úÖ Commands to whitelist are appropriate
   - ‚úÖ Risk level is acceptable
   - ‚úÖ Validation period is sufficient
   - ‚úÖ All required approvers listed

2. **Gather Approvals**
   - L3 ‚Üí L3+: Tech Lead
   - L3+ ‚Üí L4: Tech Lead, Ops Lead
   - L4 ‚Üí L4+: Tech Lead, Ops Lead, Product Lead
   - L4+ ‚Üí L5: Tech Lead, Ops Lead, Product Lead, Exec Sponsor

3. **Approve Proposal**
   ```bash
   PROPOSAL_ID="<proposal-id-from-step-1>"
   APPROVER="tech-lead"  # or ops-lead, product-lead, exec-sponsor

   curl -X POST "http://localhost:4007/api/governance/proposals/$PROPOSAL_ID/approve" \
     -H "Content-Type: application/json" \
     -d "{\"approvedBy\": \"$APPROVER\"}"
   ```

4. **Verify Phase Transition**
   ```bash
   # Check current phase
   curl http://localhost:4007/api/governance/state | jq '.currentPhase'

   # Should show new phase (e.g., "L3+" instead of "L3")
   ```

5. **Monitor Validation Period**
   - Set calendar reminder for validation period end date
   - Increase monitoring frequency during validation
   - Document any issues observed
   - Prepare rollback plan if needed

### Rolling Back Phase

**When**: Critical incident, validation failure, or stakeholder request

**Procedure**:

1. **Document Rollback Reason**
   - Record incident ID or reason
   - Note decision maker
   - Document timeline

2. **Execute Rollback**
   ```bash
   # Rollback is manual - update governance state
   # This requires direct database access or API enhancement
   # For now, manually revert in database:

   sqlite3 services/governance/var/governance.db

   UPDATE governance_state
   SET current_phase = 'L3',
       phase_start_date = datetime('now'),
       command_whitelist = '[]'
   WHERE id = 1;

   .quit
   ```

3. **Notify Stakeholders**
   - Send immediate notification to all stakeholders
   - Explain rollback reason
   - Provide timeline for investigation
   - Set expectations for next attempt

4. **Conduct Retrospective**
   - Schedule post-mortem meeting
   - Review what went wrong
   - Update readiness checklist if needed
   - Document lessons learned

## Incident Response

### Circuit Breaker Response

**When**: Circuit breaker event detected

1. **Assess Severity**
   ```bash
   curl http://localhost:4007/api/circuit-breaker/events/unresolved | jq
   ```

   Severity levels:
   - **Critical**: Immediate action required (system reverted to L3)
   - **High**: Urgent investigation needed (command type paused)
   - **Medium**: Investigation within 1 hour (alert only)
   - **Low**: Review during business hours

2. **For Critical Events (revert_to_l3)**

   a. **Verify System State**
   ```bash
   # Confirm phase reverted
   curl http://localhost:4007/api/governance/state | jq '.currentPhase'
   # Should show "L3"

   # Check command whitelist cleared
   curl http://localhost:4007/api/governance/state | jq '.commandWhitelist'
   # Should show "[]"
   ```

   b. **Investigate Root Cause**
   - Review metrics around trigger time
   - Check command service logs
   - Examine failed commands
   - Interview operators if relevant

   c. **Document Findings**
   - Create incident report
   - Note metrics at trigger time
   - Identify contributing factors
   - Propose corrective actions

   d. **Resolve Event**
   ```bash
   EVENT_ID="<event-id>"
   curl -X POST "http://localhost:4007/api/circuit-breaker/events/$EVENT_ID/resolve"
   ```

3. **For High Events (pause_command_type)**

   a. **Identify Failing Command Type**
   - Review event details
   - Check recent command failures
   - Analyze failure patterns

   b. **Fix Underlying Issue**
   - Update command logic if bug found
   - Adjust environmental conditions
   - Retrain operators if user error

   c. **Validate Fix**
   - Test command execution
   - Monitor for recurrence
   - Document validation

   d. **Resolve Event**
   ```bash
   EVENT_ID="<event-id>"
   curl -X POST "http://localhost:4007/api/circuit-breaker/events/$EVENT_ID/resolve"
   ```

4. **For Medium/Low Events (alert_only)**

   - Investigate during business hours
   - Monitor for escalation
   - Document trends
   - Consider rule adjustment if false positive

### Critical Incident Response

**When**: Critical incident attributed to autonomous actions

1. **Immediate Actions** (< 5 minutes)
   - Verify circuit breaker triggered (should auto-revert to L3)
   - If not, manually trigger revert
   - Notify on-call engineer
   - Page incident commander if production impact

2. **Stabilization** (< 15 minutes)
   - Confirm all automated commands stopped
   - Verify manual override working
   - Assess production impact
   - Implement temporary mitigations

3. **Investigation** (< 1 hour)
   - Gather timeline of events
   - Collect relevant logs
   - Review command execution history
   - Interview operators

4. **Resolution** (< 4 hours)
   - Identify root cause
   - Implement fix
   - Validate fix in test environment
   - Document incident

5. **Post-Mortem** (< 1 week)
   - Schedule blameless post-mortem
   - Document lessons learned
   - Update runbooks
   - Adjust circuit breaker rules if needed
   - Update readiness checklist

## Circuit Breaker Management

### Adjusting Circuit Breaker Rules

**When**: False positives, changed risk tolerance, or new failure modes

1. **Review Current Rules**
   ```bash
   curl http://localhost:4007/api/circuit-breaker/rules | jq
   ```

2. **Analyze False Positive Rate**
   - Review recent events
   - Calculate FP rate: (false positives) / (total triggers)
   - Target: < 5% false positive rate

3. **Update Rule**
   ```bash
   RULE_NAME="High%20Error%20Rate"

   curl -X PATCH "http://localhost:4007/api/circuit-breaker/rules/$RULE_NAME" \
     -H "Content-Type: application/json" \
     -d '{
       "condition": "errorRate > 0.08",
       "window": "10m",
       "alertSeverity": "high"
     }'
   ```

4. **Monitor Impact**
   - Track rule triggers for 1 week
   - Verify false positive reduction
   - Ensure no missed real incidents

### Adding New Circuit Breaker Rules

**When**: New failure mode identified or risk discovered

1. **Define Rule Parameters**
   - Name: Descriptive, unique
   - Condition: Threshold and metric
   - Window: Time window (e.g., "5m", "1h")
   - Action: revert_to_l3, pause_command_type, alert_only
   - Severity: critical, high, medium, low

2. **Test Rule Logic**
   - Insert test metrics
   - Verify condition evaluates correctly
   - Ensure action is appropriate

3. **Add Rule via Database**
   ```sql
   INSERT INTO circuit_breaker_rules (name, enabled, condition, window, action, alert_severity)
   VALUES ('New Rule Name', 1, 'metric > threshold', '5m', 'alert_only', 'medium');
   ```

4. **Verify Rule Active**
   ```bash
   curl http://localhost:4007/api/circuit-breaker/rules/enabled | jq
   ```

### Disabling Circuit Breaker Rules

**When**: Rule causing too many false positives or no longer relevant

‚ö†Ô∏è **Warning**: Only disable rules with stakeholder approval

```bash
RULE_NAME="High%20Rollback%20Rate"

curl -X PATCH "http://localhost:4007/api/circuit-breaker/rules/$RULE_NAME" \
  -H "Content-Type: application/json" \
  -d '{"enabled": false}'
```

## Maintenance

### Database Backups

**Frequency**: Daily

```bash
#!/bin/bash
# Backup governance database

BACKUP_DIR="/backups/governance"
DATE=$(date +%Y%m%d)
DB_PATH="services/governance/var/governance.db"

mkdir -p "$BACKUP_DIR"

# Create backup
sqlite3 "$DB_PATH" ".backup '$BACKUP_DIR/governance-$DATE.db'"

# Compress
gzip "$BACKUP_DIR/governance-$DATE.db"

# Retain last 30 days
find "$BACKUP_DIR" -name "governance-*.db.gz" -mtime +30 -delete

echo "Backup completed: governance-$DATE.db.gz"
```

### Database Cleanup

**Frequency**: Monthly

```bash
# Archive old metrics snapshots (keep last 90 days)
sqlite3 services/governance/var/governance.db <<EOF
DELETE FROM metrics_snapshots
WHERE timestamp < datetime('now', '-90 days');

DELETE FROM readiness_assessments
WHERE timestamp < datetime('now', '-90 days');

DELETE FROM circuit_breaker_events
WHERE timestamp < datetime('now', '-90 days') AND resolved = 1;

VACUUM;
EOF
```

### Log Rotation

**Frequency**: Weekly

```bash
# Rotate governance service logs
cd services/governance
mv governance.log governance.log.$(date +%Y%m%d)
gzip governance.log.$(date +%Y%m%d)
touch governance.log
kill -USR1 $(cat governance.pid)  # Reopen log file
```

## Troubleshooting

### Service Not Starting

**Symptoms**: Service fails to start, health check returns connection error

**Diagnosis**:
```bash
# Check logs
tail -f services/governance/logs/governance.log

# Common issues:
# - Port 4007 already in use
# - Database file permissions
# - Missing command database
```

**Resolution**:
```bash
# Check port usage
lsof -i :4007

# Fix database permissions
chmod 644 services/governance/var/governance.db
chown app:app services/governance/var/governance.db

# Verify command database path
ls -la services/command/var/command.db
```

### Metrics Not Updating

**Symptoms**: Grafana shows stale data, Prometheus scrape failures

**Diagnosis**:
```bash
# Check metrics endpoint
curl http://localhost:4007/metrics | grep simcorp_governance

# Check Prometheus targets
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.labels.job=="governance")'
```

**Resolution**:
```bash
# Verify metrics exporter started
# Should see in logs: "Starting periodic governance metrics updates"

# Restart service if not
systemctl restart governance

# Check Prometheus scrape config
cat /etc/prometheus/prometheus.yml | grep -A 5 governance
```

### Readiness Score Unexpectedly Low

**Symptoms**: Score dropped below 90% without clear reason

**Diagnosis**:
```bash
# Get detailed readiness report
curl http://localhost:4007/api/readiness/current | jq

# Check for blockers
curl http://localhost:4007/api/readiness/current | jq '.overall.blockers'

# Review recent metrics
curl http://localhost:4007/api/metrics/latest | jq
```

**Resolution**:
1. Address blockers listed in report
2. Review checklist items with status=false
3. Check if required items failed
4. Investigate underlying metric trends

### Circuit Breaker False Positives

**Symptoms**: Circuit breaker triggering frequently without real issues

**Diagnosis**:
```bash
# Review recent events
curl http://localhost:4007/api/circuit-breaker/events | jq

# Check rule configuration
RULE_NAME="<triggering-rule-name>"
curl "http://localhost:4007/api/circuit-breaker/rules" | jq ".[] | select(.name==\"$RULE_NAME\")"

# Analyze metrics around trigger time
```

**Resolution**:
1. Adjust rule threshold (make less sensitive)
2. Increase time window (reduce noise)
3. Change action to "alert_only" temporarily
4. Consider disabling rule if consistently false

## Emergency Contacts

### On-Call Rotation
- **Primary**: [Slack: @on-call-engineer]
- **Secondary**: [Slack: @on-call-backup]
- **Escalation**: [Slack: @engineering-leads]

### Stakeholders
- **Tech Lead**: [email]
- **Ops Lead**: [email]
- **Product Lead**: [email]
- **Exec Sponsor**: [email]

### External Resources
- Grafana Dashboard: http://localhost:3000/d/autonomy-governance
- Prometheus: http://localhost:9090
- Governance API: http://localhost:4007
- Documentation: services/governance/README.md

## Appendix: Quick Reference

### Common Commands

```bash
# Health check
curl http://localhost:4007/health

# Get current phase
curl http://localhost:4007/api/governance/state | jq '.currentPhase'

# Get readiness score
curl http://localhost:4007/api/readiness/score | jq '.score'

# Check unresolved circuit breaker events
curl http://localhost:4007/api/circuit-breaker/events/unresolved | jq 'length'

# Run weekly governance cycle
curl -X POST http://localhost:4007/api/governance/run-cycle

# Get pending proposals
curl http://localhost:4007/api/governance/proposals

# Approve proposal
curl -X POST http://localhost:4007/api/governance/proposals/{id}/approve \
  -H "Content-Type: application/json" \
  -d '{"approvedBy": "tech-lead"}'
```

### Decision Trees

**Should I approve this expansion proposal?**
1. Is readiness score ‚â• 95%? ‚Üí Yes: Continue, No: Reject
2. Are all required approvals obtained? ‚Üí Yes: Continue, No: Wait
3. Are there unresolved circuit breaker events? ‚Üí Yes: Reject, No: Continue
4. Is risk level acceptable? ‚Üí Yes: Approve, No: Request mitigation
5. Is validation period sufficient? ‚Üí Yes: Approve, No: Extend period

**Should I rollback the current phase?**
1. Is there a critical incident? ‚Üí Yes: Rollback immediately
2. Is success rate < 99%? ‚Üí Yes: Consider rollback
3. Are circuit breakers triggering frequently? ‚Üí Yes: Consider rollback
4. Is readiness score < 80%? ‚Üí Yes: Consider rollback
5. Did stakeholder request rollback? ‚Üí Yes: Rollback with approval

**Should I adjust a circuit breaker rule?**
1. Is false positive rate > 5%? ‚Üí Yes: Make less sensitive
2. Did we miss a real incident? ‚Üí Yes: Make more sensitive
3. Is rule triggering too frequently? ‚Üí Yes: Increase threshold
4. Is rule never triggering? ‚Üí Yes: Decrease threshold or remove
