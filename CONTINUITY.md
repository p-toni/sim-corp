Goal (incl. success criteria):
- ✅ M4 (Safe Autopilot L3 Beta) COMPLETE
- ✅ T-033 Agent Harness v1 (initializer + smoke + clean-state) COMPLETE
- ✅ **T-032 Command Analytics & Monitoring** COMPLETE
  - Add CommandRecord/metrics/alerts schemas in libs/schemas with tests ✅
  - Persist durable command read model (using existing command service SQLite) ✅
  - Expose analytics endpoints (list/detail, metrics, alerts, session correlation) ✅
  - Extend roaster-desktop Ops panel with Commands tab ✅
  - Add comprehensive tests (Fastify routes, analytics service) ✅
  - Run Node 20 gates and mark T-032 DONE with evidence ✅

Constraints/Assumptions:
- Full autonomy to make necessary changes
- Focus on expected outcomes and functionality
- Maintain existing architecture patterns

Key decisions:
- **T-027 Implementation (2026-01-04):**
  - Created `@sim-corp/device-identity` library with Ed25519 signing
  - Used JWT format for signatures (5-minute TTL)
  - File-based keystore for P0 (HSM for production)
  - Graceful degradation (accept unsigned telemetry)
  - Verification metadata added to envelope (`_verification` field)
- **Additional Improvements:**
  - Implemented sessionId filter in mission repository
  - Added orgId isolation test for multi-tenancy security
  - Fixed all pre-existing bugs from review
- **M3 Completion Strategy (2026-01-05):**
  - Used tcp-line driver (T-020) as "chosen vendor driver" for M3
  - Rationale: Already supports real-hardware shadow ingestion via serial→TCP bridge
  - Stack/pipeline identical regardless of machine (Bullet R1, Giesen, etc.)
  - Deferred Bullet R1 USB driver (T-029) to pilot-readiness phase
  - Bullet R1 requires research→implementation split (USB protocol not documented)

State:
Done:
- T-001 to T-028 — All tasks DONE and verified
- M1 (Mission Inbox + Profiles + Predictive Assist + Tauri) — COMPLETE
- M2 (Trust & Provenance) — COMPLETE
- M3 (Design Partner Pilot: Eval Harness + Vendor Driver) — COMPLETE
- **T-026 Auth & Tenancy (Clerk) + Permissions (Verified 2026-01-06):**
  - Clerk JWT verification with jose library and JWKS validation
  - Multi-tenancy enforcement via `ensureOrgAccess` helper
  - Dev mode fallback for local development (AUTH_MODE=dev)
  - Desktop ClerkProvider integration with token attachment
  - AuthContext and useAuthInfo hook for app-wide auth state
  - Organization support from Clerk metadata
  - 24 ingestion tests passing, 15 desktop tests passing
  - Routes properly use `ensureOrgAccess` for org-level isolation
- **T-027 Deliverables:**
  - Device identity library (192 LOC, 13 tests passing)
  - Sim-publisher signing integration (3 tests passing)
  - Ingestion verification (24 tests passing)
  - Comprehensive ops documentation (376 lines in `docs/ops/device-identity.md`)
  - Task registry updated
- **Improvements from review:**
  - SessionId filter in mission repository
  - OrgId isolation security test (12 tests in missions.routes.test.ts)
  - Mission filtering bug fix
  - Sim-roast-runner vitest alias fix
  - Settings test localStorage mock
  - Tauri plugin dependency fix
- **Test Status:**
  - Individual package tests: 100% passing
  - Parallel test runs: Minor isolation issues (not code bugs)
  - Total: 157 tests across 51 test files
- **Trust Visualization (2026-01-04):**
  - TrustBadge component in Live Mode (verified/unsigned/failed states)
  - Trust metrics in session schema (telemetryPoints, verifiedPoints, etc.)
  - Trust metrics calculated and stored by persistence pipeline
  - Trust metrics included in roast reports
  - Trust metrics UI in ReportPanel (verification rate, device IDs)
- **T-028 Eval Harness + Auto-Eval (2026-01-04 to 2026-01-05):**
  - **Schemas:** Enhanced GoldenCase, EvalRun, DetailedMetrics, LMJudgeScore
  - **Eval Service:** SQLite storage, MetricsCalculator, Evaluator, gate logic
  - **REST API:** Golden cases CRUD, run evaluation, check promotion (5 tests)
  - **Auto-Evaluation:** EvalServiceClient + AutoEvaluator integrated with PersistencePipeline
  - **Report Integration:** Evaluations field in RoastReport, GET_EVALUATIONS_TOOL
  - **UI Visualization:** Evaluation results panel (outcome badges, metrics, gates)
  - **Configuration:** Environment-gated (AUTO_EVAL_ENABLED, EVAL_SERVICE_URL)
  - **Documentation:** docs/ops/eval-harness.md (500+ lines)
  - **Tests:** All passing (eval 5, ingestion 24, agent 1, desktop build)
- **T-030 L3 Autopilot Foundation (2026-01-05):**
  - **T-030.1 Command Schemas:** 7 comprehensive schemas (272 LOC)
    - RoasterCommand, CommandProposal, CommandExecutionResult
    - CommandApprovalRequest/Response, CommandBatch, CommandConstraintsPreset
    - 14 test cases covering all schemas and lifecycle scenarios
    - Total: 44 schema tests passing
  - **T-030.3 Driver Write Interface:** Extended Driver interface
    - writeCommand(), abortCommand(), getCommandStatus()
    - CommandStatus interface for tracking
    - Backward compatible (optional methods)
    - Comprehensive documentation
  - **T-031 Fake Driver Commands:** Test infrastructure complete
    - Implemented all write methods in FakeDriver
    - Command types: SET_POWER, SET_FAN, SET_DRUM, ABORT, PREHEAT
    - Simulates execution (10-50ms delay), tracks state
    - Constraint enforcement (range clamping)
    - 12 command tests, 15 total tests passing
- **M4 Safe Autopilot L3 Beta (2026-01-06):**
  - **Command Service** (`services/command`)
    - SQLite storage with complete lifecycle tracking
    - Proposal submission, approval/rejection workflow
    - REST API: 7 endpoints (POST/GET proposals, approve, reject, execute, abort, status)
    - 10 integration tests passing
  - **Safety Infrastructure**
    - Multi-layer validation: constraints, state guards, rate limits
    - Command-specific ranges (power 0-100%, fan 1-10, drum 0-100 RPM)
    - Ramp rate limits, interval limits, daily count limits
  - **Command Executor**
    - Coordinates approved command execution with drivers
    - Driver.writeCommand() / abortCommand() / getCommandStatus()
    - Complete outcome tracking and error handling
  - **Audit Trail**
    - Immutable logging from proposal → outcome
    - Actor tracking (USER, AGENT, DEVICE, SYSTEM)
    - Event log: PROPOSED, APPROVED, REJECTED, EXECUTING, COMPLETED, FAILED, ABORTED
  - **Documentation**
    - Comprehensive ops guide (docs/ops/command-service.md)
    - API reference, safety gates, driver integration, troubleshooting
    - 600+ lines of production-ready documentation
  - **Zero Uncontrolled Actuation Achieved**
    - All commands require approval path (HITL)
    - No commands execute without validation + approval
    - Complete audit trail for regulatory compliance
- **T-032 Command Analytics & Monitoring (2026-01-06):**
  - **Analytics Schemas** (libs/schemas/src/kernel/command.ts)
    - CommandMetrics: aggregated metrics with success rates, latency percentiles
    - CommandTimeseriesMetrics: time-bucketed data for charting
    - CommandAlert: safety violations, anomaly detection
    - CommandSummary: dashboard statistics with 24h/7d windows
    - ProposeCommandRequest: missing schema for proposal API
    - 6 new schema tests (50 total tests passing)
  - **Analytics Service** (services/command/src/core/analytics.ts)
    - getMetrics(): success rates, latency p50/p95/p99, by command type/machine
    - getTimeseriesMetrics(): bucketed data for charting
    - getAlerts(): high failure rate and latency anomaly detection
    - getSummary(): dashboard with 24h/7d metrics, pending approvals
  - **Analytics API Routes** (services/command/src/routes/analytics.ts)
    - GET /analytics/metrics
    - GET /analytics/metrics/timeseries
    - GET /analytics/alerts
    - GET /analytics/summary
  - **Analytics Tests** (services/command/tests/analytics.test.ts)
    - 7 comprehensive tests covering all analytics functions
    - 17 total command service tests passing
  - **Desktop Commands Tab** (apps/roaster-desktop)
    - Command API client (command-api.ts)
    - Tabbed Ops panel (Missions | Commands)
    - Command list with filters, detail panel, approval/rejection actions
    - Analytics summary display (pending approvals, success rates, 24h totals)
    - Desktop build successful
- **T-030.5 Desktop Command Approval UX (2026-01-06):**
  - **SafetyInfoPanel Component** (apps/roaster-desktop/src/components/SafetyInfoPanel.tsx)
    - Displays command safety constraints and limits
    - Shows value ranges, ramp rates, required/forbidden states, rate limits
    - OUT OF RANGE warning when target value violates constraints
    - 10 comprehensive tests covering all constraint types
  - **CommandApprovalDialog Component** (apps/roaster-desktop/src/components/CommandApprovalDialog.tsx)
    - Modal dialog for command approval with safety acknowledgment
    - Shows command details, approval deadline (with urgency warning), reasoning
    - Integrates SafetyInfoPanel for inline safety review
    - Requires explicit checkbox acknowledgment before approval
  - **CommandRejectionDialog Component** (apps/roaster-desktop/src/components/CommandRejectionDialog.tsx)
    - Structured rejection reasons (7 predefined codes)
    - Custom reason text for "OTHER" category
    - Warning about permanent rejection with audit log recording
  - **Enhanced OpsPanel** (apps/roaster-desktop/src/components/OpsPanel.tsx)
    - Approve button opens CommandApprovalDialog
    - Reject button opens CommandRejectionDialog
    - SafetyInfoPanel integrated in command detail view
    - Modal styling (apps/roaster-desktop/src/app.css)
  - **15 desktop tests passing** (including 10 new SafetyInfoPanel tests)
  - **Desktop build successful**

Now:
- **T-026 Auth & Tenancy Verification** COMPLETE (2026-01-06)
  - Verified Clerk JWT integration with jose library
  - Multi-tenancy enforcement working with ensureOrgAccess
  - All tests passing: Ingestion 24 tests, Desktop 15 tests
  - M2 (Trust & Provenance) fully verified and complete
  - M4 (Safe Autopilot L3 Beta) fully complete

Next:
- T-028 P1 — LM-as-judge implementation (deferred to post-M4)
- T-029 — Bullet R1 USB driver (pilot-readiness follow-on, requires hardware)
- M5 — Production Hardening (HSM integration, multi-node, monitoring)

Open questions (UNCONFIRMED if needed):
- Event inference heuristics: May need machine-specific calibration for production
- Multi-node deployment: SQLite replication strategy for M5+
- Key rotation: Automation strategy for production
- HSM integration: Timeline for production hardening

Working set (files/ids/commands):
- CONTINUITY.md
- docs/tasks/task-registry.md
- docs/ops/device-identity.md
- docs/ops/eval-harness.md
- docs/ops/command-service.md (NEW — M4 documentation)
- libs/device-identity/* (device identity library)
- libs/schemas/src/kernel/eval.ts (enhanced eval schemas)
- libs/schemas/src/domain/roast-report.ts (TrustMetrics + evaluations)
- libs/schemas/src/domain/session.ts (trust metrics fields)
- services/eval/* (eval service)
  - src/db/connection.ts (SQLite schema)
  - src/db/repo.ts (golden cases + eval runs)
  - src/core/metrics-calculator.ts
  - src/core/evaluator.ts
  - src/core/eval-service.ts
  - src/routes/golden-cases.ts
  - src/routes/evaluations.ts
  - src/server.ts
  - tests/eval-service.test.ts (5 tests)
- services/sim-publisher/src/core/publish.ts (signing integrated)
- services/ingestion/src/core/signature-verifier.ts
- services/ingestion/src/core/handlers.ts (verification integrated)
- services/ingestion/src/core/persist.ts (trust metrics tracking)
- services/ingestion/src/core/eval-client.ts (NEW — HTTP client for eval service)
- services/ingestion/src/core/auto-evaluator.ts (NEW — session close eval)
- services/ingestion/src/server.ts (auto-eval integration)
- services/company-kernel/src/db/repo.ts (sessionId filter)
- services/company-kernel/tests/missions.routes.test.ts (orgId isolation test)
- agents/roast-report-agent/src/agent.ts (evaluations in reports)
- agents/roast-report-agent/src/tools.ts (GET_EVALUATIONS_TOOL)
- apps/roaster-desktop/src/components/TrustBadge.tsx
- apps/roaster-desktop/src/components/ReportPanel.tsx (trust + eval UI)
- apps/roaster-desktop/src/app.tsx (live mode trust badge)
- apps/roaster-desktop/src/app.css (trust badge styles)
- services/command/* (NEW — M4 command service)
  - src/db/connection.ts (SQLite schema)
  - src/db/repo.ts (command proposals repository)
  - src/core/command-service.ts (proposal + approval workflow)
  - src/core/executor.ts (command execution coordinator)
  - src/core/validators.ts (safety gates: constraints, state, rate limits)
  - src/routes/proposals.ts (proposal endpoints)
  - src/routes/execution.ts (execution endpoints)
  - src/server.ts (fastify server)
  - tests/command-service.test.ts (10 tests)
- libs/schemas/src/kernel/command.ts (7 command schemas + 5 analytics schemas, 50 tests)
- drivers/core/src/types.ts (extended Driver interface with write methods)
- drivers/fake/src/fake-driver.ts (command support implementation)
- services/command/src/core/analytics.ts (NEW — T-032 analytics engine)
- services/command/src/routes/analytics.ts (NEW — T-032 analytics endpoints)
- services/command/tests/analytics.test.ts (NEW — T-032 7 analytics tests)
- apps/roaster-desktop/src/lib/command-api.ts (NEW — T-032 command API client)
- apps/roaster-desktop/src/components/OpsPanel.tsx (T-032 Commands tab extension)
